#include <UserButton.h>
#include <Timer.h>
#include "Kotsis.h"

module kotsisC @safe()
{
	uses interface Leds;
	uses interface Boot;
	uses interface Get<button_state_t>;
	uses interface Notify<button_state_t>;
	uses interface Timer<TMilli> as Timer1;

	uses interface SplitControl as AMControl;
	uses interface AMSend;
	uses interface AMPacket;
	uses interface Packet;
	uses interface Receive;
}

implementation
{
	int number=0;
	int flag = 0;
	int counter = 0;
	message_t pkt;

	//BOOT
	event void Boot.booted()
	{
		call Notify.enable();
		call AMControl.start();
	}

	//NOTIFY
	event void Notify.notify( button_state_t state ) 
	{
		if ( state == BUTTON_RELEASED && number > 0 ) 
		{
			call Leds.led0Toggle();
			if(flag==0)
			{
				flag=1;
			}
			else if(flag==1)
			{
				flag=0;
				number=0;
			}
		}
		if ( state == BUTTON_PRESSED ) 
		{
			call Leds.led0On();
			call Leds.led2Off();
		}
		if ( state == BUTTON_RELEASED && flag == 0 ) 
		{
			call AMSend.send( AM_BROADCAST_ADDR , &pkt , sizeof(RadioMsg));
			call Leds.led0Off();
			number++;
		}
	}
	
	//FIRED
	event void Timer1.fired() 
	{
		call Leds.led2Off();
		call AMSend.send( AM_BROADCAST_ADDR , &pkt , sizeof(RadioMsg));
	}

	//STARTDONE
	event void AMControl.startDone( error_t err ) 
	{
		if ( err == SUCCESS ) 
		{
			RadioMsg* Rpkt = (RadioMsg*)(call Packet.getPayload(&pkt, sizeof(RadioMsg)));
			if (Rpkt == NULL) 
			{
				return;
			}
			Rpkt -> nodeid = TOS_NODE_ID;
			Rpkt -> counter = counter;
		}
		else 
		{
			call AMControl.start();
		}
	}

	//STOPDONE
	event void AMControl.stopDone( error_t ) 
	{
	}

	//SENDDONE
	event void AMSend.sendDone( message_t *msg , error_t error ) 
	{
		if ( error == SUCCESS ) 
		{
		
		}
	}

	//RECEIVE
	event message_t* Receive.receive(message_t *msg, void *payload, uint8_t len) 
	{
		if ( len == sizeof(RadioMsg)) 
		{
			RadioMsg* Rpkt = (RadioMsg*) payload;
			if(Rpkt->counter==0)
			{
				call Leds.led2On();
			}
		}
		if ( flag == 0 )
		{
			call Timer1.startOneShot(4000);
		}
		return msg;
	}
}


// orizoume mia metabliti typou int me timh flag=0
// ftiaxnoume to event Boot.booted() dhladh molis arxisei to programma --->>>>
// na kalesei to command Notify.enable() to opoio energopoiei thn epikoinonia me to button
// otan patithei to button tote anabei to led0 otan afhsoume to button to led0 kleinei.
// -------- etsi me to anigokleisimo blepoume an ontos patithike to button ----------

